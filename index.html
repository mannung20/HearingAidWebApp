<!DOCTYPE html>
<html>
<head>
<title>보청기 웹앱</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); max-width: 400px; width: 100%; text-align: center; }
h1 { color: #333; margin-bottom: 30px; font-size: 1.8em; }
.permission-guide { background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; display: none; }
.controls { margin-bottom: 30px; }
button { background: #4CAF50; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 25px; font-size: 16px; cursor: pointer; transition: all 0.3s; min-width: 120px; font-weight: bold; }
button:hover { transform: translateY(-2px); }
button:disabled { background: #cccccc; cursor: not-allowed; transform: none; }
.permission-btn { background: #2196F3; }
#stopButton { background: #f44336; }
.volume-control { margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
.volume-control label { display: block; margin-bottom: 15px; font-weight: bold; color: #333; font-size: 1.1em; }
#volumeSlider { width: 100%; height: 8px; background: #ddd; outline: none; border-radius: 5px; margin-bottom: 15px; }
#volumeSlider::-webkit-slider-thumb { appearance: none; width: 25px; height: 25px; background: #4CAF50; border-radius: 50%; cursor: pointer; }
#volumeDisplay { font-size: 1.5em; font-weight: bold; color: #4CAF50; }
#status { padding: 15px; border-radius: 8px; font-weight: bold; background: #e8f5e8; color: #2e7d2e; margin-top: 20px; font-size: 1.1em; }
@media (max-width: 480px) { body { padding: 10px; } .container { padding: 20px; } h1 { font-size: 1.5em; } button { padding: 12px 20px; font-size: 14px; margin: 5px; } }
</style>
</head>
<body>
  <div class="container">
    <h1>🔊 보청기 웹앱</h1>
    
    <div id="permissionGuide" class="permission-guide">
      <strong>📱 마이크 권한 허용 방법:</strong><br>
      1. 주소창 좌측 🔒 아이콘 클릭<br>
      2. "마이크" → "허용" 선택<br>
      3. 페이지 새로고침 후 다시 시도
    </div>
    
    <div class="controls">
      <button id="permissionBtn" class="permission-btn">🎤 마이크 권한 요청</button>
      <button id="startButton">시작</button>
      <button id="stopButton">정지</button>
    </div>
    
    <div class="volume-control">
      <label for="volumeSlider">볼륨:</label>
      <input type="range" id="volumeSlider" min="0" max="100" value="50">
      <span id="volumeDisplay">50</span>%
    </div>
    
    <div id="status">🎤 마이크 권한을 요청해주세요</div>
  </div>

<script>
const permissionBtn = document.getElementById('permissionBtn');
const startButton = document.getElementById('startButton');
const stopButton = document.getElementById('stopButton');
const volumeSlider = document.getElementById('volumeSlider');
const volumeDisplay = document.getElementById('volumeDisplay');
const statusDiv = document.getElementById('status');
const permissionGuide = document.getElementById('permissionGuide');

let audioContext, microphoneStream, gainNode, highpassFilter, isRunning = false;
let hasPermission = false;

// 초기 상태 설정
startButton.disabled = true;
stopButton.disabled = true;

// 1단계: 마이크 권한 요청
permissionBtn.addEventListener('click', async () => {
  try {
    statusDiv.textContent = '🔄 마이크 권한 확인 중...';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.color = '#856404';
    
    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
    
    // 권한 성공 - 임시 스트림 종료
    stream.getTracks().forEach(track => track.stop());
    hasPermission = true;
    
    statusDiv.textContent = '✅ 마이크 권한 허용됨 - 시작 버튼을 눌러주세요';
    statusDiv.style.background = '#d4edda';
    statusDiv.style.color = '#155724';
    
    permissionBtn.disabled = true;
    startButton.disabled = false;
    permissionGuide.style.display = 'none';
    
  } catch (err) {
    let errorMessage = '❌ 마이크 접근 실패: ';
    if (err.name === 'NotAllowedError') {
      errorMessage += '마이크 권한을 허용해주세요.';
    } else if (err.name === 'NotFoundError') {
      errorMessage += '마이크 장치가 발견되지 않았습니다.';
    } else if (err.name === 'OverconstrainedError'){
        errorMessage += '지원되지 않는 마이크 설정입니다.';
    } else {
      errorMessage += err.message;
    }
    statusDiv.textContent = errorMessage;
    statusDiv.style.background = '#f8d7da';
    statusDiv.style.color = '#721c24';
    permissionGuide.style.display = 'block';
    console.error('권한 오류:', err);
  }
});

// 2단계: 보청기 시작
startButton.addEventListener('click', async () => {
  try {
    statusDiv.textContent = '🚀 보청기 시작 중...';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.color = '#856404';
    
    microphoneStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false
      }
    });
    
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    console.log("AudioContext state:", audioContext.state); //추가
    if (audioContext.state === 'suspended') {
        await audioContext.resume();
        console.log("AudioContext resumed"); //추가
    }

    const source = audioContext.createMediaStreamSource(microphoneStream);
    gainNode = audioContext.createGain();
    highpassFilter = audioContext.createBiquadFilter();
    highpassFilter.type = 'highpass';
    highpassFilter.frequency.setValueAtTime(100, audioContext.currentTime); // 100Hz highpass filter

    const volume = volumeSlider.value / 100;
    gainNode.gain.value = volume * 2;

    source.connect(highpassFilter);
    highpassFilter.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    startButton.disabled = true;
    stopButton.disabled = false;
    isRunning = true;
    
    statusDiv.textContent = '🔊 보청기 작동 중 (이어폰 착용 권장)';
    statusDiv.style.background = '#d4edda';
    statusDiv.style.color = '#155724';
    
  } catch (err) {
    let errorMessage = '❌ 보청기 시작 실패: ';
    if (err.name === 'NotAllowedError') {
        errorMessage += '마이크 권한을 허용해주세요.';
    } else if (err.name === 'NotFoundError'){
        errorMessage += 'AudioContext가 지원되지 않습니다.';
    } else if (err.name === 'OverconstrainedError'){
        errorMessage += '지원되지 않는 마이크 설정입니다.';
    } else {
      errorMessage += err.message;
    }
    statusDiv.textContent = errorMessage;
    statusDiv.style.background = '#f8d7da';
    statusDiv.style.color = '#721c24';
    permissionGuide.style.display = 'block';
    console.error('보청기 시작 오류:', err);
  }
});

// 3단계: 보청기 정지
stopButton.addEventListener('click', () => {
  if (microphoneStream) {
    microphoneStream.getTracks().forEach(track => track.stop());
    microphoneStream = null;
  }
  if (audioContext) {
    audioContext.close();
    audioContext = null;
  }
  
  startButton.disabled = false;
  stopButton.disabled = true;
  isRunning = false;
  
  statusDiv.textContent = '⏹️ 보청기 정지됨';
  statusDiv.style.background = '#f8d7da';
  statusDiv.style.color = '#721c24';
});

// 볼륨 조절
volumeSlider.addEventListener('input', function() {
  const volume = this.value / 100;
  volumeDisplay.textContent = this.value;
  
  if (gainNode && isRunning) {
    gainNode.gain.value = volume * 2;
  }
});

// 페이지 종료 시 정리
window.addEventListener('beforeunload', () => {
  if (microphoneStream) microphoneStream.getTracks().forEach(track => track.stop());
  if (audioContext) audioContext.close();
});

// 오디오 컨텍스트 자동 재개
document.addEventListener('click', () => {
  if (audioContext && audioContext.state === 'suspended') audioContext.resume();
});
</script>
</body>
</html>